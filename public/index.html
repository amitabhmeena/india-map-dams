<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>India Map â€“ Dams & Boundaries</title>

  <link rel="stylesheet"
        href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    html, body, #viewDiv {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 99;
      font-family: Arial;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
  </style>
</head>

<body>

<div id="controls">
  <label>
    <input type="checkbox" id="damToggle">
    Dam Locations
  </label>
</div>

<div id="viewDiv"></div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/MapImageLayer",
  "esri/layers/GraphicsLayer",
  "esri/Graphic",
  "esri/config"
], function (
  Map, MapView, MapImageLayer, GraphicsLayer, Graphic, esriConfig
) {

  /* ðŸ” Bharat Map token injection (example: State Boundary) */
  esriConfig.request.interceptors.push({
    urls: /mapservice\.gov\.in/,
    before: function (params) {
      params.requestOptions.query =
        params.requestOptions.query || {};
      if (params.url.includes("State_Boundary")) {
        params.requestOptions.query.token = "PASTE_YOUR_NEW_REFERRER_TOKEN_HERE";
      }
    }
  });

  /* ðŸ—ºï¸ Boundary layer */
  const stateLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/State_Boundary/MapServer",
    visible: true
  });

  const map = new Map({
    basemap: "topo-vector",
    layers: [stateLayer]
  });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [78.9629, 22.5937],
    zoom: 4
  });

  /* ðŸ”´ Dam layer */
  const damLayer = new GraphicsLayer({ visible: false });
  map.add(damLayer);

  document.getElementById("damToggle").addEventListener("change", e => {
    damLayer.visible = e.target.checked;
  });

  /* DMS â†’ Decimal converter */
  function dmsToDecimal(dms) {
    if (!dms) return null;
    const p = dms.match(/\d+/g);
    if (!p || p.length < 2) return null;
    return (+p[0]) + (+p[1] / 60) + ((+p[2] || 0) / 3600);
  }

  /* ðŸ“‚ Load static dams.json */
  fetch("dams.json")
    .then(res => res.json())
    .then(json => {
      json.data.forEach(dam => {
        const lat = dmsToDecimal(dam.Latitude);
        const lon = dmsToDecimal(dam.Longitude);
        if (!lat || !lon) return;

        damLayer.add(new Graphic({
          geometry: {
            type: "point",
            latitude: lat,
            longitude: lon
          },
          symbol: {
            type: "simple-marker",
            color: "red",
            size: 6,
            outline: { color: "white", width: 1 }
          },
          popupTemplate: {
            title: dam.Name_of_Dam,
            content: `
              <b>State:</b> ${dam.State}<br>
              <b>District:</b> ${dam.District}<br>
              <b>Purpose:</b> ${dam.Purpose}<br>
              <b>Year:</b> ${dam["Year of completion"]}
            `
          }
        }));
      });
    });

});
</script>

</body>
</html>
