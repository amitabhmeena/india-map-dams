<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>India Map â€“ Boundaries & Dams</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    html, body, #viewDiv {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }

    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 12px;
      z-index: 99;
      font-family: Arial, sans-serif;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 260px;
    }

    .section {
      margin-top: 8px;
      font-weight: bold;
    }

    label {
      display: block;
      margin-top: 4px;
      cursor: pointer;
    }

    select {
      width: 100%;
      margin-top: 5px;
      padding: 4px;
    }
  </style>
</head>

<body>

<div id="controls">

  <div class="section">Basemap</div>
  <select id="basemapSelect">
    <option value="topo">Topographic (Default)</option>
    <option value="satellite">Satellite</option>
    <option value="streets">Street</option>
    <option value="none">No basemap</option>
  </select>

  <div class="section">Boundaries</div>
  <label><input type="checkbox" id="stateChk" checked> State Boundary</label>
  <label><input type="checkbox" id="districtChk"> District Boundary</label>
  <label><input type="checkbox" id="riverChk"> River</label>
  <label><input type="checkbox" id="watershedChk"> Watershed</label>

  <div class="section">Infrastructure</div>
  <label><input type="checkbox" id="damChk" checked> Dam Locations</label>

</div>

<div id="viewDiv"></div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/MapImageLayer",
  "esri/layers/GraphicsLayer",
  "esri/Graphic",
  "esri/widgets/Search",
  "esri/config"
], function (
  Map, MapView,
  MapImageLayer, GraphicsLayer, Graphic,
  Search, esriConfig
) {

  /* ðŸ” Bharat Map token interceptor */
  esriConfig.request.interceptors.push({
    urls: /mapservice\.gov\.in/,
    before: function (params) {
      params.requestOptions.query = params.requestOptions.query || {};
      const u = params.url;

      if (u.includes("State_Boundary"))
        params.requestOptions.query.token =
          "B_MvXZQQA3UJQ3rriTr7Qvo4AE-8f2v0JmAgH3h17-3OVcp7agXot9jS8Q7ZPelzaaShzPs5CR7tqOeucn4Oww..";
      else if (u.includes("District_Boundary"))
        params.requestOptions.query.token =
          "KLafX5W7tKxU3qXCTtWzmiub5IsvSYcYf8OYVbFZaO_5Dlji_67_mzrUu6qCgWJ6djeLy_izw-rxbEWms3Ss0g..";
      else if (u.includes("River"))
        params.requestOptions.query.token =
          "aprsZsvhLhQlrHeo2O-9F-PWMUmaTr7awaxuyKOXtWOMMp0VVG70sfDnNltnsh3SLOqcK8zLNCvPqBThYxn5tw..";
      else if (u.includes("Watershed"))
        params.requestOptions.query.token =
          "LYFmEZL-IKy3-iAuFBbGMpNs0rPaWFMD5KuaJUT7I6OFXUWRxnUhDjR3SJfE-ndgh9aAdyua9Cs8b9POB7R51Q..";
    }
  });

  /* ðŸ—ºï¸ Boundary layers */
  const stateLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/State_Boundary/MapServer",
    visible: true
  });

  const districtLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/District_Boundary/MapServer",
    visible: false
  });

  const riverLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/River/MapServer",
    visible: false
  });

  const watershedLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/Watershed/MapServer",
    visible: false
  });

  /* ðŸ”´ Dam layer */
  const damLayer = new GraphicsLayer({ visible: true });

  /* ðŸ—ºï¸ Map */
  const map = new Map({
    basemap: "topo-vector",
    layers: [
      stateLayer,
      districtLayer,
      riverLayer,
      watershedLayer,
      damLayer
    ]
  });

  /* ðŸ‡®ðŸ‡³ India extent (correct initial view) */
  const indiaExtent = {
    xmin: 68,
    ymin: 6,
    xmax: 97,
    ymax: 37,
    spatialReference: { wkid: 4326 }
  };

  const view = new MapView({
    container: "viewDiv",
    map: map,
    extent: indiaExtent
  });

  /* Basemap switch */
  basemapSelect.onchange = () => {
    if (basemapSelect.value === "none") map.basemap = null;
    else if (basemapSelect.value === "satellite") map.basemap = "satellite";
    else if (basemapSelect.value === "streets") map.basemap = "streets-vector";
    else map.basemap = "topo-vector";
  };

  /* Layer toggles */
  stateChk.onchange = () => stateLayer.visible = stateChk.checked;
  districtChk.onchange = () => districtLayer.visible = districtChk.checked;
  riverChk.onchange = () => riverLayer.visible = riverChk.checked;
  watershedChk.onchange = () => watershedLayer.visible = watershedChk.checked;
  damChk.onchange = () => damLayer.visible = damChk.checked;

  /* DMS â†’ Decimal */
  function dmsToDecimal(dms) {
    if (!dms) return null;
    const p = dms.match(/\d+/g);
    if (!p || p.length < 2) return null;
    return (+p[0]) + (+p[1] / 60) + ((+p[2] || 0) / 3600);
  }

  /* Load dams.json */
  fetch("dams.json")
    .then(r => r.json())
    .then(json => {
      json.data.forEach(dam => {
        const lat = dmsToDecimal(dam.Latitude);
        const lon = dmsToDecimal(dam.Longitude);
        if (!lat || !lon) return;

        damLayer.add(new Graphic({
          geometry: { type: "point", latitude: lat, longitude: lon },
          attributes: dam,
          symbol: {
            type: "simple-marker",
            color: [255, 0, 0, 0.9],
            size: 7,
            outline: { color: "white", width: 1.5 }
          },
          popupTemplate: {
            title: "{Name_of_Dam}",
            content: `
              <b>State:</b> {State}<br>
              <b>District:</b> {District}<br>
              <b>Purpose:</b> {Purpose}<br>
              <b>Year:</b> {Year of completion}
            `
          }
        }));
      });

      /* ðŸ” Search widget (DAM NAME SEARCH) */
      const search = new Search({
        view: view,
        allPlaceholder: "Search dam name",
        includeDefaultSources: false,
        sources: [{
          layer: damLayer,
          searchFields: ["Name_of_Dam"],
          displayField: "Name_of_Dam",
          exactMatch: false,
          outFields: ["*"],
          name: "Dams",
          placeholder: "Type dam name"
        }]
      });

      view.ui.add(search, "top-right");
    });

  /* Hover popup */
  view.on("pointer-move", event => {
    view.hitTest(event).then(resp => {
      const hit = resp.results.find(r => r.graphic.layer === damLayer);
      if (hit) {
        view.popup.open({
          location: hit.graphic.geometry,
          title: hit.graphic.attributes.Name_of_Dam,
          content: ""
        });
      } else {
        view.popup.close();
      }
    });
  });

});
</script>

</body>
</html>
