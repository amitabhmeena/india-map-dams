<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>India Map â€“ 2D / 3D Boundaries & Dams</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    html, body, #viewDiv {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }

    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 12px;
      z-index: 99;
      font-family: Arial, sans-serif;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 260px;
    }

    .section {
      margin-top: 8px;
      font-weight: bold;
    }

    label {
      display: block;
      margin-top: 4px;
      cursor: pointer;
    }

    select {
      width: 100%;
      margin-top: 5px;
      padding: 4px;
    }
  </style>
</head>

<body>

<div id="controls">

  <div class="section">View Mode</div>
  <select id="viewMode">
    <option value="2d">2D Map</option>
    <option value="3d">3D Scene (Satellite)</option>
  </select>

  <div class="section">Basemap (2D)</div>
  <select id="basemapSelect">
    <option value="topo">Topographic (Default)</option>
    <option value="satellite">Satellite</option>
    <option value="streets">Street</option>
    <option value="none">No basemap</option>
  </select>

  <div class="section">Boundaries (2D)</div>
  <label><input type="checkbox" id="stateChk" checked> State Boundary</label>
  <label><input type="checkbox" id="districtChk"> District Boundary</label>
  <label><input type="checkbox" id="riverChk"> River</label>
  <label><input type="checkbox" id="watershedChk"> Watershed</label>

  <div class="section">Infrastructure</div>
  <label><input type="checkbox" id="damChk" checked> Dam Locations</label>

</div>

<div id="viewDiv"></div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/views/SceneView",
  "esri/layers/MapImageLayer",
  "esri/layers/GraphicsLayer",
  "esri/Graphic",
  "esri/config"
], function (
  Map, MapView, SceneView,
  MapImageLayer, GraphicsLayer, Graphic, esriConfig
) {

  /* ðŸ” Bharat Map token interceptor */
  esriConfig.request.interceptors.push({
    urls: /mapservice\.gov\.in/,
    before: function (params) {
      params.requestOptions.query = params.requestOptions.query || {};
      const u = params.url;

      if (u.includes("State_Boundary"))
        params.requestOptions.query.token =
          "B_MvXZQQA3UJQ3rriTr7Qvo4AE-8f2v0JmAgH3h17-3OVcp7agXot9jS8Q7ZPelzaaShzPs5CR7tqOeucn4Oww..";
      else if (u.includes("District_Boundary"))
        params.requestOptions.query.token =
          "KLafX5W7tKxU3qXCTtWzmiub5IsvSYcYf8OYVbFZaO_5Dlji_67_mzrUu6qCgWJ6djeLy_izw-rxbEWms3Ss0g..";
      else if (u.includes("River"))
        params.requestOptions.query.token =
          "aprsZsvhLhQlrHeo2O-9F-PWMUmaTr7awaxuyKOXtWOMMp0VVG70sfDnNltnsh3SLOqcK8zLNCvPqBThYxn5tw..";
      else if (u.includes("Watershed"))
        params.requestOptions.query.token =
          "LYFmEZL-IKy3-iAuFBbGMpNs0rPaWFMD5KuaJUT7I6OFXUWRxnUhDjR3SJfE-ndgh9aAdyua9Cs8b9POB7R51Q..";
    }
  });

  /* ðŸ—ºï¸ Boundary layers (2D only) */
  const stateLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/State_Boundary/MapServer",
    visible: true
  });

  const districtLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/District_Boundary/MapServer",
    visible: false
  });

  const riverLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/River/MapServer",
    visible: false
  });

  const watershedLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/Watershed/MapServer",
    visible: false
  });

  /* ðŸ—ºï¸ Maps */
  const map2D = new Map({
    basemap: "topo-vector",
    layers: [stateLayer, districtLayer, riverLayer, watershedLayer]
  });

  const map3D = new Map({
    basemap: "satellite",
    ground: "world-elevation"
  });

  /* ðŸ”´ Dam layers (SEPARATE) */
  const damLayer2D = new GraphicsLayer({ visible: true });
  const damLayer3D = new GraphicsLayer({ visible: true });

  map2D.add(damLayer2D);
  map3D.add(damLayer3D);

  /* Views */
  const mapView = new MapView({
    container: "viewDiv",
    map: map2D,
    center: [78.9629, 22.5937],
    zoom: 4
  });

  const sceneView = new SceneView({
    container: null,
    map: map3D,
    center: [78.9629, 22.5937],
    zoom: 4
  });

  /* Improve 3D performance */
  sceneView.qualityProfile = "low";
  sceneView.environment.atmosphereEnabled = false;
  sceneView.environment.starsEnabled = false;

  viewMode.value = "2d";

  /* View switch */
  viewMode.onchange = () => {
    if (viewMode.value === "3d") {
      mapView.container = null;
      sceneView.container = "viewDiv";
    } else {
      sceneView.container = null;
      mapView.container = "viewDiv";
    }
  };

  /* Basemap switch (2D only) */
  basemapSelect.onchange = () => {
    if (basemapSelect.value === "none") map2D.basemap = null;
    else if (basemapSelect.value === "satellite") map2D.basemap = "satellite";
    else if (basemapSelect.value === "streets") map2D.basemap = "streets-vector";
    else map2D.basemap = "topo-vector";
  };

  /* Boundary toggles */
  stateChk.onchange = () => stateLayer.visible = stateChk.checked;
  districtChk.onchange = () => districtLayer.visible = districtChk.checked;
  riverChk.onchange = () => riverLayer.visible = riverChk.checked;
  watershedChk.onchange = () => watershedLayer.visible = watershedChk.checked;

  /* Dam toggle */
  damChk.onchange = () => {
    damLayer2D.visible = damChk.checked;
    damLayer3D.visible = damChk.checked;
  };

  /* DMS â†’ Decimal */
  function dmsToDecimal(dms) {
    if (!dms) return null;
    const p = dms.match(/\d+/g);
    if (!p || p.length < 2) return null;
    return (+p[0]) + (+p[1] / 60) + ((+p[2] || 0) / 3600);
  }

  /* Load dams.json */
  fetch("dams.json")
    .then(r => r.json())
    .then(json => {
      json.data.forEach(dam => {
        const lat = dmsToDecimal(dam.Latitude);
        const lon = dmsToDecimal(dam.Longitude);
        if (!lat || !lon) return;

        const popupTemplate = {
          title: dam.Name_of_Dam,
          content: `
            <b>State:</b> ${dam.State}<br>
            <b>District:</b> ${dam.District}<br>
            <b>Purpose:</b> ${dam.Purpose}<br>
            <b>Year:</b> ${dam["Year of completion"]}
          `
        };

        // 2D graphic
        damLayer2D.add(new Graphic({
          geometry: { type: "point", latitude: lat, longitude: lon },
          symbol: {
            type: "simple-marker",
            color: "red",
            size: 6,
            outline: { color: "white", width: 1 }
          },
          popupTemplate
        }));

        // 3D graphic (smaller, faster)
        damLayer3D.add(new Graphic({
          geometry: { type: "point", latitude: lat, longitude: lon },
          symbol: {
            type: "simple-marker",
            color: "red",
            size: 4,
            outline: { color: "white", width: 0.5 }
          },
          popupTemplate
        }));
      });
    });

  /* Hover popup (2D only) */
  mapView.on("pointer-move", event => {
    if (viewMode.value !== "2d") return;

    mapView.hitTest(event).then(resp => {
      const hit = resp.results.find(r => r.graphic.layer === damLayer2D);
      if (hit) {
        mapView.popup.open({
          location: hit.graphic.geometry,
          title: hit.graphic.popupTemplate.title,
          content: ""
        });
      } else {
        mapView.popup.close();
      }
    });
  });

});
</script>

</body>
</html>
