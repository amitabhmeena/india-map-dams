<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>India Map – Dams & Boundaries</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
<script src="https://js.arcgis.com/4.29/"></script>

<style>
html, body, #viewDiv {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
}

#controls {
  position: absolute;
  top: 12px;
  left: 12px;
  background: white;
  padding: 14px;
  z-index: 99;
  font-family: Arial, sans-serif;
  font-size: 13px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  width: 340px;
  border-radius: 10px;
}

.section {
  font-weight: bold;
  margin-top: 10px;
}

input[type="text"], select {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

#results {
  max-height: 160px;
  overflow-y: auto;
  border: 1px solid #ccc;
  border-radius: 6px;
  display: none;
  margin-top: 4px;
}

.result-item {
  padding: 6px;
  cursor: pointer;
}
.result-item:hover {
  background: #f0f0f0;
}
</style>
</head>

<body>

<div id="controls">

  <!-- Search -->
  <div class="section">Search Dam</div>
  <input type="text" id="damSearch" placeholder="Type dam name…" />
  <div id="results"></div>

  <!-- Basemap -->
  <div class="section">Basemap</div>
  <select id="basemapSelect">
    <option value="satellite" selected>Satellite</option>
    <option value="streets">Street</option>
    <option value="topo">Topographic</option>
    <option value="none">No basemap</option>
  </select>

  <!-- Layers -->
  <div class="section">Layers</div>
  <label><input type="checkbox" id="stateChk" checked> State Boundary</label><br>
  <label><input type="checkbox" id="districtChk"> District Boundary</label><br>
  <label><input type="checkbox" id="riverChk"> River</label><br>
  <label><input type="checkbox" id="watershedChk"> Watershed</label><br>
  <label><input type="checkbox" id="damChk" checked> Dams</label>

</div>

<div id="viewDiv"></div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/MapImageLayer",
  "esri/layers/GraphicsLayer",
  "esri/Graphic",
  "esri/symbols/TextSymbol",
  "esri/config"
], function (
  Map, MapView,
  MapImageLayer, GraphicsLayer, Graphic, TextSymbol, esriConfig
) {

  /* Token interceptor */
  esriConfig.request.interceptors.push({
    urls: /mapservice\.gov\.in/,
    before: p => {
      p.requestOptions.query = p.requestOptions.query || {};
      const u = p.url;
      if (u.includes("State_Boundary"))
        p.requestOptions.query.token = "B_MvXZQQA3UJQ3rriTr7Qvo4AE-8f2v0JmAgH3h17-3OVcp7agXot9jS8Q7ZPelzaaShzPs5CR7tqOeucn4Oww..";
      else if (u.includes("District_Boundary"))
        p.requestOptions.query.token = "KLafX5W7tKxU3qXCTtWzmiub5IsvSYcYf8OYVbFZaO_5Dlji_67_mzrUu6qCgWJ6djeLy_izw-rxbEWms3Ss0g..";
      else if (u.includes("River"))
        p.requestOptions.query.token = "aprsZsvhLhQlrHeo2O-9F-PWMUmaTr7awaxuyKOXtWOMMp0VVG70sfDnNltnsh3SLOqcK8zLNCvPqBThYxn5tw..";
      else if (u.includes("Watershed"))
        p.requestOptions.query.token = "LYFmEZL-IKy3-iAuFBbGMpNs0rPaWFMD5KuaJUT7I6OFXUWRxnUhDjR3SJfE-ndgh9aAdyua9Cs8b9POB7R51Q..";
    }
  });

  /* Layers */
  const stateLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/State_Boundary/MapServer",
    visible: true
  });

  const districtLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/District_Boundary/MapServer",
    visible: false
  });

  const riverLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/River/MapServer",
    visible: false
  });

  const watershedLayer = new MapImageLayer({
    url: "https://mapservice.gov.in/gismapservice/rest/services/BharatMapService/Watershed/MapServer",
    visible: false
  });

  const damLayer = new GraphicsLayer({ visible: true });
  const largeLabelLayer = new GraphicsLayer({ visible: false });
  const smallLabelLayer = new GraphicsLayer({ visible: false });

  const map = new Map({
    basemap: "satellite",
    layers: [
      stateLayer,
      districtLayer,
      riverLayer,
      watershedLayer,
      damLayer,
      largeLabelLayer,
      smallLabelLayer
    ]
  });

  const view = new MapView({
    container: "viewDiv",
    map,
    extent: { xmin: 68, ymin: 6, xmax: 97, ymax: 37, spatialReference: { wkid: 4326 } }
  });

  /* Toggle bindings */
  basemapSelect.onchange = () => {
    map.basemap =
      basemapSelect.value === "none" ? null :
      basemapSelect.value === "satellite" ? "satellite" :
      basemapSelect.value === "streets" ? "streets-vector" :
      "topo-vector";
  };

  stateChk.onchange = () => stateLayer.visible = stateChk.checked;
  districtChk.onchange = () => districtLayer.visible = districtChk.checked;
  riverChk.onchange = () => riverLayer.visible = riverChk.checked;
  watershedChk.onchange = () => watershedLayer.visible = watershedChk.checked;

  damChk.onchange = () => {
    damLayer.visible = damChk.checked;
    largeLabelLayer.visible = damChk.checked && view.zoom >= 7;
    smallLabelLayer.visible = damChk.checked && view.zoom >= 10;
  };

  function dmsToDecimal(dms) {
    const p = dms?.match(/\d+/g);
    return p ? (+p[0] + p[1]/60 + (p[2]||0)/3600) : null;
  }

  function wrapLabel(name) {
    const parts = name.split(" ");
    if (parts.length <= 2) return name;
    const mid = Math.ceil(parts.length / 2);
    return parts.slice(0, mid).join(" ") + "\n" + parts.slice(mid).join(" ");
  }

  const damGraphics = [];

  fetch("dams.json")
    .then(r => r.json())
    .then(json => {
      json.data.forEach(dam => {

        const lat = dmsToDecimal(dam.Latitude);
        const lon = dmsToDecimal(dam.Longitude);
        if (!lat || !lon) return;

        const storage = Number(dam["Gross Storage Capacity(mcm)"]);
        const isLarge = (!isNaN(storage) && storage >= 500);
        const symbolSize = isLarge ? 5 : 2;

        const g = new Graphic({
          geometry: { type: "point", latitude: lat, longitude: lon },
          attributes: dam,
          symbol: {
            type: "simple-marker",
            color: [0,102,204,0.9],
            size: symbolSize,
            outline: null
          },
          popupTemplate: {
            title: dam.Name_of_Dam,
            content: Object.entries(dam)
              .map(([k,v]) => `<b>${k}:</b> ${v ?? "-"}`)
              .join("<br>")
          }
        });

        damGraphics.push(g);
        damLayer.add(g);

        const labelGraphic = new Graphic({
          geometry: g.geometry,
          symbol: new TextSymbol({
            text: wrapLabel(dam.Name_of_Dam),
            color: "orange",
            font: { size: 8, family: "Arial", weight: "bold" },
            yoffset: 8
          })
        });

        if (isLarge) {
          largeLabelLayer.add(labelGraphic);
        } else {
          smallLabelLayer.add(labelGraphic);
        }
      });
    });

  /* Zoom-based label visibility */
  view.watch("zoom", z => {
    largeLabelLayer.visible = (z >= 7);
    smallLabelLayer.visible = (z >= 10);
  });

  /* Search with smooth zoom */
  damSearch.addEventListener("input", function () {
    const q = this.value.toLowerCase();
    results.innerHTML = "";
    results.style.display = "none";
    if (!q) return;

    const matches = damGraphics
      .filter(g => g.attributes.Name_of_Dam.toLowerCase().includes(q))
      .slice(0, 10);

    if (!matches.length) return;

    results.style.display = "block";
    matches.forEach(g => {
      const div = document.createElement("div");
      div.className = "result-item";
      div.textContent = g.attributes.Name_of_Dam;
      div.onclick = () => {
        results.style.display = "none";
        damSearch.value = g.attributes.Name_of_Dam;
        view.goTo(
          { target: g.geometry, zoom: 11 },
          { duration: 2000, easing: "ease-in-out" }
        );
        view.popup.open({ location: g.geometry });
      };
      results.appendChild(div);
    });
  });

});
</script>

</body>
</html>
